version: "3.7"

services:
  nginx:
    container_name: pypi_nginx
    hostname: nginx
    image: nginx:1.18.0-alpine
    privileged: true
    restart: unless-stopped
    networks:
      pypiserver_net:
        ipv4_address: 192.168.41.2
    ports:
      - 8080:80
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $PWD/pypimanager-nginx/conf:/etc/nginx
      - $PWD/pypimanager-nginx/cache:/data/nginx/cache
      - $PWD/pypimanager-nginx/logs:/var/log/nginx
      - $PWD/pypiserver/packages:/data/packages
  pypi-server:
    container_name: pypi_server
    image: pypiserver/pypiserver:v1.4.2
    restart: unless-stopped
    privileged: true
    networks:
      pypiserver_net:
        ipv4_address: 192.168.41.3
    # ports:
    #   - 8081:8080
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $PWD/pypiserver/packages:/data/packages
      - $PWD/pypiserver/logs:/logs
      - $PWD/pypiserver/pypipasswd:/pypipasswd
    command: -v --log-file=/logs/pypiserver.log -P /pypipasswd -a update -r /data/packages -o
  db:
    image: mysql:5.7
    container_name: pypi_mysql
    privileged: true
    restart: unless-stopped
    networks:
      pypiserver_net:
        ipv4_address: 192.168.41.4
    ports:
      - 3306:3306
    volumes:
      - /etc/localhost:/etc/localhost
      - $PWD/pypimanager-mysql/data:/var/lib/mysql
      - $PWD/pypimanager-mysql/conf/my.cnf:/etc/mysql/my.cnf
      - $PWD/pypimanager-mysql/logs:/var/log/mysql
    environment:
      # 请务必修改密码
      MYSQL_ROOT_PASSWORD: "123456"
    command: --default-authentication-plugin=mysql_native_password
    entrypoint: bash -c "chown -R mysql:mysql /var/log/mysql && chmod 1777 /var/log/mysql && exec /entrypoint.sh mysqld"

networks:
  pypiserver_net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 192.168.41.0/16
